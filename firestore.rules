
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Admins have full access to everything
    function isAdmin() {
      // IMPORTANT: Replace with the actual Admin UID
      return request.auth.uid == 'JT6PeEV2i2VOd4jTqXM1x1ZzXFZ2';
    }

    // Allow read/write access to user-specific documents
    match /users/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // Allow read/write access to user progress
    match /userProgress/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // Allow anyone to create short URLs, but only admins can manage them fully
    match /shortenedUrls/{alias} {
      allow read;
      allow create; // Let anyone shorten a URL
      allow update, delete: if isAdmin();
    }

    // Allow users to submit bug reports and admins to manage them
    match /bugReports/{reportId} {
      allow create: if isAuthenticated(); // Any authenticated user can create a report
      // Users can read their own reports, admins can read any report.
      allow read: if isAdmin() || isOwner(resource.data.userId);
      // Only admins can update or delete reports.
      allow update, delete: if isAdmin();
    }

    // Allow anyone to read announcements
    match /global_announcements/{announcementId} {
      allow read;
      allow create, update, delete: if isAdmin();
    }
  }
}
